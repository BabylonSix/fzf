# Custom FZF Fork

Private fork of [junegunn/fzf](https://github.com/junegunn/fzf) with SIGUSR1-based live color reloading.

## Why Fork?

fzf has no mechanism for live color switching while running (upstream issue [#3861](https://github.com/junegunn/fzf/issues/3861), unresolved through v0.68.0). fzf reads `FZF_DEFAULT_OPTS` at startup and never re-evaluates colors. The BRAVO themer ecosystem needs all apps to live-switch between Catppuccin Mocha (dark) and Rose Pine Dawn (light) when macOS appearance toggles.

## What Changed

### SIGUSR1 Live Color Reload

On receiving `SIGUSR1`, fzf:

1. Reads color specs from `~/.config/fzf/colors`
2. Parses specs via existing `parseTheme()` (supports `--color=dark`, `--color=bg:#1e1e2e,...`)
3. Copies theme struct contents in-place (`*t.theme = *theme`) so the renderer's shared pointer stays valid
4. Calls `InitTheme()` to repopulate global `Col*` variables
5. Triggers `reqFullRedraw` (fzf chrome: bg, borders, text, prompt, info)
6. Triggers `reqPreviewRerun` (re-executes preview command so bat picks up new theme)

### Files Modified

| File | Change |
|------|--------|
| `src/terminal.go` | `reloadColors()` method, `extractColorSpecs()` helper, `reqPreviewRerun` request type, SIGUSR1 goroutine setup, `baseTheme`/`bold`/`black` fields on Terminal struct |
| `src/terminal_unix.go` | `notifyOnUsr1()` — registers SIGUSR1 signal handler |
| `src/terminal_windows.go` | `notifyOnUsr1()` — noop (SIGUSR1 not available on Windows) |
| `src/actiontype_string.go` | Regenerated by `go generate` after adding `reqPreviewRerun` |

### Key Technical Details

- **File-based config, not env vars:** `os.Getenv()` reads the process's env copy from launch time — shell updates are invisible to child processes. The colors file is read fresh on every signal.
- **In-place theme copy:** `t.theme = theme` (pointer reassign) breaks the renderer because `LightWindow.bg` caches from `r.theme` at window creation. Must use `*t.theme = *theme` to copy struct contents so the shared pointer stays valid.
- **`reqPreviewRerun` vs `reqPreviewRefresh`:** `reqPreviewRefresh` calls `printPreview()` which only re-renders cached ANSI output. `reqPreviewRerun` calls `refreshPreview()` which actually re-executes the preview command (bat), so bat reads its updated `--theme` from `~/.config/bat/config`.
- **Signal pattern:** Channel + goroutine, same as existing SIGWINCH handler.

## Integration with BRAVO Themer

The themer (`~/.dotfiles/config/themer/themer.sh`) handles the full flow:

```
dark-notify detects OS toggle
  → themer.sh callback
    → _themer_set_fzf: writes ~/.config/fzf/colors + pkill -USR1 fzf
    → _themer_set_bat: seds ~/.config/bat/config --theme value
```

### Colors File Format

`~/.config/fzf/colors` — one `--color` flag per line:

```
--color=dark
--color=bg:#1e1e2e,bg+:#313244,fg:#cdd6f4,fg+:#cdd6f4
--color=hl:#f38ba8,hl+:#f38ba8,info:#cba6f7,marker:#f5e0dc
--color=prompt:#cba6f7,spinner:#f5e0dc,pointer:#f5e0dc,header:#f38ba8
--color=border:#585b70,label:#cdd6f4,query:#cdd6f4
```

First line must be the base theme (`--color=dark` or `--color=light`).

## Install

### Prerequisites

- Go 1.21+ (`brew install go`)
- `stringer` tool: `go install golang.org/x/tools/cmd/stringer@latest`

### Build & Deploy

```bash
cd ~/ai-projects/fzf
go build -o fzf                          # build binary
cp fzf ~/.dotfiles/bin/fzf               # deploy to PATH (overrides brew)
```

`~/.dotfiles/bin` is first in PATH (`env/path.sh`), so the custom binary takes priority over `brew install fzf`.

### Verify

```bash
which fzf                                # should show ~/.dotfiles/bin/fzf
fzf --version                            # should match upstream version
# Test live switching:
fzf --preview 'bat --color=always {}'    # start fzf with bat preview
pkill -USR1 fzf                          # trigger color reload
```

### From Scratch (New Machine)

```bash
# 1. Clone the fork
git clone git@github.com:BabylonSix/fzf.git ~/ai-projects/fzf

# 2. Build
cd ~/ai-projects/fzf
go build -o fzf

# 3. Deploy
cp fzf ~/.dotfiles/bin/fzf

# 4. Ensure colors file exists (themer creates this on first run)
mkdir -p ~/.config/fzf
# themer.sh writes ~/.config/fzf/colors on startup
```

## Upstream Compatibility

The fork tracks upstream `master`. Changes are isolated to 4 files and don't conflict with normal fzf development. To sync with upstream:

```bash
git fetch upstream
git merge upstream/master
go build -o fzf
```
